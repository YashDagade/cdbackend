<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Stream Accident Detector Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stream-selector {
            text-align: center;
            margin-bottom: 15px;
        }
        .stream-selector label {
            margin-right: 10px;
            font-weight: bold;
        }
        .stream-selector input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 200px;
        }
        .connection-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            transition: background-color 0.3s ease;
        }
        #connectBtn {
            background-color: #28a745;
        }
        #connectBtn:hover:not(:disabled) {
            background-color: #218838;
        }
        #disconnectBtn {
            background-color: #dc3545;
        }
        #disconnectBtn:hover:not(:disabled) {
            background-color: #c82333;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status-section {
            border: 1px solid #eee;
            padding: 20px;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .connection-status {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1em;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }
        .connected {
            background-color: #28a745; /* Green */
        }
        .disconnected {
            background-color: #dc3545; /* Red */
        }
        .initializing {
             background-color: #ffc107; /* Yellow */
        }
        #videoFeed {
            width: 100%;
            max-width: 800px;
            height: auto;
            display: block;
            margin: 0 auto 15px auto;
            border: 3px solid #ddd;
            background-color: #000;
            min-height: 300px; /* Placeholder height */
        }
        #accidentStatus {
            font-size: 1.2em;
            font-weight: bold;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            margin-top: 10px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .status-accident {
            background-color: #f8d7da; /* Light red */
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-no_accident {
            background-color: #d4edda; /* Light green */
            color: #155724;
            border: 1px solid #c3e6cb;
        }
         .status-initializing,
         .status-no_frame,
         .status-error,
         .status-disconnected {
            background-color: #fff3cd; /* Light yellow */
            color: #856404;
            border: 1px solid #ffeeba;
        }
        #detectionDetails {
            font-size: 0.9em;
            color: #555;
            margin-top: 10px;
            text-align: center;
            word-wrap: break-word;
        }
        .log-container {
            margin-top: 20px;
        }
        .log {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Multi-Stream Accident Detector</h1>
    
    <div class="container">
        <div class="stream-selector">
            <label for="streamIdInput">Stream ID:</label>
            <input type="text" id="streamIdInput" value="mn_c550" placeholder="Enter Stream ID (e.g., mn_c550)">
        </div>
        
        <div class="connection-controls">
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
        </div>
        
        <div class="status-section video-section">
            <div class="connection-status">
                <div class="status-indicator disconnected" id="connectionStatusIndicator"></div>
                <span id="connectionStatusText">Stream Disconnected</span>
            </div>
            <img id="videoFeed" src="data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=" alt="Video Feed Loading...">
        </div>
        
        <div class="status-section detection-section">
            <div class="connection-status">
                 <div class="status-indicator disconnected" id="detectionSystemIndicator"></div>
                 <span>Detection Status:</span>
             </div>
            <div id="accidentStatus" class="status-disconnected">Enter Stream ID and Connect</div>
            <div id="detectionDetails"></div>
        </div>
        
        <div class="log-container">
            <h3>Log</h3>
            <div class="log" id="log"></div>
        </div>
    </div>
    
    <script>
        // DOM elements
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const streamIdInput = document.getElementById('streamIdInput');
        const videoFeed = document.getElementById('videoFeed');
        const accidentStatusDiv = document.getElementById('accidentStatus');
        const detectionDetailsDiv = document.getElementById('detectionDetails');
        const connectionStatusIndicator = document.getElementById('connectionStatusIndicator');
        const detectionSystemIndicator = document.getElementById('detectionSystemIndicator');
        const connectionStatusText = document.getElementById('connectionStatusText');
        const logDiv = document.getElementById('log');
        
        // WebSocket connection
        let streamSocket = null;
        let currentStreamId = '';
        
        // FPS calculation
        let lastFrameTime = 0;
        let frameCount = 0;
        let fpsUpdateInterval = null;
        let lastFps = 0;
        
        // Log helper
        function log(message) {
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            // Auto-scroll to the bottom
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Format timestamp
        function formatTimestamp(isoString) {
            if (!isoString) return 'N/A';
            try {
                return new Date(isoString).toLocaleString();
            } catch (e) {
                return isoString; // Return original if parsing fails
            }
        }
        
        // Update UI elements based on received data
        function updateUI(data) {
            // Update Video Frame
            if (data.frame) {
                videoFeed.src = `data:image/jpeg;base64,${data.frame}`;
                frameCount++; // Increment frame count for FPS
            } else {
                // Optionally: show a placeholder if frame is null
                 videoFeed.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs="; // Blank gif
            }
            
            // Update Detection Status
            if (data.detection) {
                const detection = data.detection;
                accidentStatusDiv.textContent = detection.result.replace('_', ' ').toUpperCase(); // e.g., NO ACCIDENT
                accidentStatusDiv.className = `status-${detection.result}`; // Use result for class
                
                let details = `Location: ${detection.location || 'N/A'} | Last Check: ${formatTimestamp(detection.timestamp)}`;
                 if (detection.result === 'accident' && detection.description) {
                    details += ` | Description: ${detection.description}`;
                }
                if (detection.status === 'error' && detection.error_message) {
                    details += ` | Error: ${detection.error_message}`;
                }
                detectionDetailsDiv.textContent = details;
                
                // Update detection system indicator based on status
                updateDetectionSystemStatus(detection.status);
            } else {
                // Handle case where detection object might be missing
                accidentStatusDiv.textContent = 'Waiting for detection data...';
                accidentStatusDiv.className = 'status-initializing';
                detectionDetailsDiv.textContent = '';
                 updateDetectionSystemStatus('initializing');
            }
        }
        
        // Update connection status indicators and button states
        function updateConnectionVisuals(isConnected, streamId = '') {
            if (isConnected) {
                connectionStatusIndicator.className = 'status-indicator connected';
                connectionStatusText.textContent = `Stream Connected: ${streamId}`;
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                streamIdInput.disabled = true; // Disable input when connected
            } else {
                connectionStatusIndicator.className = 'status-indicator disconnected';
                 detectionSystemIndicator.className = 'status-indicator disconnected'; // Also reset detection indicator
                connectionStatusText.textContent = 'Stream Disconnected';
                accidentStatusDiv.textContent = 'Disconnected';
                accidentStatusDiv.className = 'status-disconnected';
                detectionDetailsDiv.textContent = '';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                 streamIdInput.disabled = false; // Enable input when disconnected
                // Reset video feed to placeholder
                 videoFeed.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=";
            }
        }
        
        function updateDetectionSystemStatus(status) {
             let indicatorClass = 'status-indicator';
             switch(status) {
                 case 'success': indicatorClass += ' connected'; break; // Green
                 case 'initializing': indicatorClass += ' initializing'; break; // Yellow
                 case 'no_frame': indicatorClass += ' initializing'; break; // Yellow (waiting for frame)
                 case 'error': indicatorClass += ' disconnected'; break; // Red
                 default: indicatorClass += ' disconnected'; // Default to red
             }
             detectionSystemIndicator.className = indicatorClass;
        }
        
        // Start FPS counter
        function startFpsCounter() {
             stopFpsCounter(); // Clear any existing interval
             lastFrameTime = Date.now();
             frameCount = 0;
             lastFps = 0;
             fpsUpdateInterval = setInterval(() => {
                 const now = Date.now();
                 const elapsed = (now - lastFrameTime) / 1000;
                 if (elapsed > 0) {
                    lastFps = frameCount / elapsed;
                 }
                 // Update status text instead of logging continuously
                 connectionStatusText.textContent = `Stream Connected: ${currentStreamId} (${lastFps.toFixed(1)} FPS)`;
                 lastFrameTime = now;
                 frameCount = 0;
             }, 2000); // Update FPS display every 2 seconds
        }
        
        // Stop FPS counter
        function stopFpsCounter() {
            if (fpsUpdateInterval) {
                clearInterval(fpsUpdateInterval);
                fpsUpdateInterval = null;
            }
        }
        
        // Connect WebSocket
        function connect() {
            currentStreamId = streamIdInput.value.trim();
            if (!currentStreamId) {
                log("Error: Stream ID cannot be empty.");
                alert("Please enter a Stream ID.");
                return;
            }
            
            if (streamSocket) {
                log("Already connected or connecting.");
                return;
            }
            
            // Determine WebSocket protocol and base URL
             const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
             const host = window.location.hostname;
             // Use default port 8000 for local, otherwise use standard ports
             const port = (host === 'localhost' || host === '127.0.0.1') ? ':8000' : ''; 
             const wsUrl = `${protocol}//${host}${port}/ws/stream/${currentStreamId}`;
            
            log(`Attempting to connect to: ${wsUrl}`);
            updateConnectionVisuals(false); // Show as disconnected initially
            connectionStatusText.textContent = `Connecting to ${currentStreamId}...`;
             accidentStatusDiv.textContent = 'Connecting...';
             accidentStatusDiv.className = 'status-initializing';
            
            try {
                streamSocket = new WebSocket(wsUrl);
                
                streamSocket.onopen = () => {
                    log(`Connected to stream: ${currentStreamId}`);
                    updateConnectionVisuals(true, currentStreamId);
                    startFpsCounter();
                };
                
                streamSocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        updateUI(data);
                    } catch (e) {
                        log(`Error parsing message: ${e.message}`);
                        console.error("Raw message:", event.data);
                    }
                };
                
                streamSocket.onclose = (event) => {
                    log(`Disconnected from stream: ${currentStreamId}. Code: ${event.code}, Reason: ${event.reason || 'N/A'}`);
                    updateConnectionVisuals(false);
                    streamSocket = null;
                    stopFpsCounter();
                };
                
                streamSocket.onerror = (error) => {
                    log(`WebSocket error for stream ${currentStreamId}. See console for details.`);
                    console.error("WebSocket Error:", error);
                    // updateConnectionVisuals(false); // onclose will handle this
                    // streamSocket = null;
                    // stopFpsCounter();
                };
                
            } catch (error) {
                log(`Error creating WebSocket: ${error.message}`);
                updateConnectionVisuals(false);
            }
        }
        
        // Disconnect WebSocket
        function disconnect() {
            stopFpsCounter();
            if (streamSocket) {
                log(`Disconnecting from stream: ${currentStreamId}...`);
                streamSocket.close(1000, "Client requested disconnect"); // Normal closure
                streamSocket = null; // Ensure it's nulled immediately
            } else {
                log("Already disconnected.");
            }
            // updateConnectionVisuals(false); // onclose handler will call this
        }
        
        // Event listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        
        // Initial log message
        log('Client loaded. Enter Stream ID and click Connect.');
    </script>
</body>
</html> 